<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.koscom.batch.push.mapper.PushMapper">

    <select id="getPushAD01Info"  parameterType="com.koscom.batch.push.domain.Ad01SegmentInfo" resultType="com.koscom.batch.push.domain.Ad01SegmentInfo">
		/* com.koscom.batch.push.mapper.PushMapper.getPushAD01Info : 변동 내역 조회 */
		SELECT  *
		  FROM CREDIT_CHANGE_INFO AI /* 신용변동내역 */
		 WHERE AI.NO_PERSON      = #{no_person             , jdbcType=VARCHAR}
		   AND AI.DT_INFO_CHANGE = #{dt_info_change        , jdbcType=VARCHAR}
	</select>
	<insert id="insertPushHist" parameterType="com.koscom.batch.push.domain.Ad01SegmentInfo">
		/* com.koscom.batch.push.mapper.PushMapper.insertPushHist : 변동 내역 등록 */
		INSERT INTO CREDIT_CHANGE_INFO
		(NO_PERSON,DT_INFO_CHANGE,HP,EMAIL,YN_CREDIT_INFO,YN_KFB_DEFAULT,
		YN_KCI_DEFAULT,YN_REF_INFO,YN_LOAN_INFO,YN_GUARANTEE_INFO,
		YN_FNCO_DISORDER_INFO,YN_PUBLIC_INFO,KCBDI,ID_FRT,DT_FRT
		) VALUES (
		  #{no_person             , jdbcType=VARCHAR}
		, #{dt_info_change        , jdbcType=VARCHAR}
		, #{hp                    , jdbcType=VARCHAR}
		, #{email                 , jdbcType=VARCHAR}
		, #{yn_credit_info        , jdbcType=VARCHAR}
		, #{yn_kfb_default        , jdbcType=VARCHAR}
		, #{yn_kci_default        , jdbcType=VARCHAR}
		, #{yn_ref_info           , jdbcType=VARCHAR}
		, #{yn_loan_info          , jdbcType=VARCHAR}
		, #{yn_guarantee_info     , jdbcType=VARCHAR}
		, #{yn_fnco_disorder_info , jdbcType=VARCHAR}
		, #{yn_public_info        , jdbcType=VARCHAR}
		, #{kcbdi                 , jdbcType=VARCHAR}
		, #{id_frt                , jdbcType=VARCHAR}
		, SYSDATE
		)
	</insert>
	<update id="updatePushHist" parameterType="com.koscom.batch.push.domain.Ad01SegmentInfo">
		/* com.koscom.batch.push.mapper.PushMapper.updatePushHist : 변동 내역 수정 */
		UPDATE CREDIT_CHANGE_INFO
		  SET HP                    = #{hp                    , jdbcType=VARCHAR}
		    , EMAIL                 = #{email                 , jdbcType=VARCHAR}
		    , YN_CREDIT_INFO        = #{yn_credit_info        , jdbcType=VARCHAR}
		    , YN_KFB_DEFAULT        = #{yn_kfb_default        , jdbcType=VARCHAR}
		    , YN_KCI_DEFAULT        = #{yn_kci_default        , jdbcType=VARCHAR}
		    , YN_REF_INFO           = #{yn_ref_info           , jdbcType=VARCHAR}
		    , YN_LOAN_INFO          = #{yn_loan_info          , jdbcType=VARCHAR}
		    , YN_GUARANTEE_INFO     = #{yn_guarantee_info     , jdbcType=VARCHAR}
		    , YN_FNCO_DISORDER_INFO = #{yn_fnco_disorder_info , jdbcType=VARCHAR}
		    , YN_PUBLIC_INFO        = #{yn_public_info        , jdbcType=VARCHAR}
		    , KCBDI                 = #{kcbdi                 , jdbcType=VARCHAR}
		    , ID_FRT                = #{id_frt                , jdbcType=VARCHAR}
		    , DT_FRT                = SYSDATE
		 WHERE NO_PERSON             = #{no_person             , jdbcType=VARCHAR}
		   AND DT_INFO_CHANGE        = #{dt_info_change        , jdbcType=VARCHAR}
	</update>
	<!-- 푸시 AD01 등록-->
	<insert id="createPushAD01Info" parameterType="com.koscom.batch.push.domain.PushEachVO">

		<selectKey keyProperty="seq_push" resultType="int" order="BEFORE">
			(SELECT NVL(MAX(seq_push),0)+1 FROM push_AD01_info)
		</selectKey>

		INSERT INTO PUSH_AD01_INFO (
			seq_push
			, no_person
            , push_divcd
			, title
			, body
			, link_addr
			, dt_reserv
			, yn_send
			, yn_process
			, yn_display
			, id_frt
		    , dt_frt
		    , id_lst
			, dt_lst
			)
		VALUES (
			  #{seq_push}
			, #{no_person, jdbcType=VARCHAR}
			, #{push_divcd, jdbcType=VARCHAR}
			, #{title, jdbcType=VARCHAR}
			, #{body, jdbcType=VARCHAR}
			, #{link_addr, jdbcType=VARCHAR}
			, SYSDATE
			, #{yn_send, jdbcType=VARCHAR}
			, 'N'
			, #{yn_display, jdbcType=VARCHAR}
            , #{id_frt, jdbcType=VARCHAR}
			, SYSDATE  /*dt_reserv*/
            , #{id_frt, jdbcType=VARCHAR}
			, SYSDATE  /*dt_reserv*/
			)
	</insert>

    <!-- 푸시 목록-->
    <select id="listPushAD01Info"  parameterType="com.koscom.batch.push.domain.PushEachForm" resultType="com.koscom.batch.push.domain.PushEachVO">
	    /* com.koscom.batch.push.mapper.PushMapper.listPushAD01Info : 푸시 목록 조회 */
	    /* 부채, 신용*/
	    SELECT  AI.SEQ_PUSH
              , AI.PUSH_DIVCD /* 푸쉬구분 */
              , AI.NO_PERSON
              , AI.TITLE
			  , AI.BODY
			  , AI.LINK_ADDR
			  , AI.DT_RESERV
			  , AI.YN_PROCESS
			  , AI.YN_DISPLAY
			  , AI.YN_SEND
			  , AI.ID_FRT
			  , AI.DT_FRT
			  , AI.ID_LST
			  , AI.DT_LST
			  , PI.FCM_TOKEN
			  , PI.YN_OS
              ,NVL((SELECT MAX(PSI.YN_PUSH) FROM PUSH_SETTING_INFO PSI WHERE no_person = AI.no_person AND PSI.CD_PUSH = '02'),'N') AS yn_push2 /* 푸쉬메세지사용여부(신용) */
              ,NVL((SELECT MAX(PSI.YN_PUSH) FROM PUSH_SETTING_INFO PSI WHERE no_person = AI.no_person AND PSI.CD_PUSH = '03'),'N') AS yn_push3 /* 푸쉬메세지사용여부(부채) */
		  FROM PUSH_AD01_INFO AI /* 개인별 푸쉬 메시지 */
		      ,PERSON_INFO    PI
	     WHERE AI.YN_PROCESS = 'N'
	       AND AI.NO_PERSON = PI.NO_PERSON
    </select>

    <!-- 푸시 AD01 UPDATE-->
	<update id="modifyYnPushAD01" parameterType="com.koscom.batch.push.domain.PushEachVO">
		/* com.koscom.batch.push.mapper.PushMapper.listPushAD01Info : 푸시 AD01 UPDATE */
		UPDATE PUSH_AD01_INFO
		SET    YN_PROCESS = 'Y'
			  ,ID_LST = #{id_lst, jdbcType=VARCHAR}
			  ,DT_LST = SYSDATE
		WHERE seq_push = #{seq_push}
	</update>

	<!-- 푸시 등록-->
	<insert id="createPushEachInfo" parameterType="com.koscom.batch.push.domain.PushEachVO">
		<selectKey keyProperty="seq_push" resultType="int" order="BEFORE">
			(SELECT NVL(MAX(seq_push),0)+1 FROM push_each_info)
		</selectKey>
		/* com.koscom.pusheach.dao.PushEachMapper.createPushEachInfo : 푸시 등록 */
		INSERT INTO PUSH_EACH_INFO (
			  SEQ_PUSH
			, NO_PERSON
			, TITLE
			, BODY
			, PUSH_DIVCD
			, LINK_ADDR
			, YN_SEND
            , YN_DISPLAY
			, DT_RESERV
			, ID_FRT
			, DT_FRT
			, ID_LST
			, DT_LST
			)
		VALUES (
			  #{seq_push}
			, #{no_person, jdbcType=VARCHAR}
			, #{title, jdbcType=VARCHAR}
			, #{body, jdbcType=VARCHAR}
			, #{push_divcd, jdbcType=VARCHAR}
			, #{link_addr, jdbcType=VARCHAR}
			, NVL(#{yn_send   , jdbcType=VARCHAR}, 'Y')
		    , NVL(#{yn_display, jdbcType=VARCHAR}, 'Y')
			, SYSDATE
			, #{id_frt, jdbcType=VARCHAR}
			, SYSDATE
			, #{id_frt, jdbcType=VARCHAR}
			, SYSDATE
			)
	</insert>

	<!-- 부채 푸시 대상자 리스트-->
    <select id="listPushDebtPerson"  parameterType="com.koscom.batch.push.domain.PushEachForm" resultType="com.koscom.batch.push.domain.PushEachVO">
	    /* com.koscom.batch.push.mapper.PushMapper.listPushDebtPerson : 부채 푸시 대상자 조회 */
	    SELECT DISTINCT
	    	P.NO_PERSON,
	    	P.YN_OS,
	    	P.CD_PUSH,
			P.FCM_TOKEN
		FROM
			PERSON_INFO P
		INNER JOIN DEBT_PERSONAL_INFO DPI ON
			P.NO_PERSON = DPI.NO_PERSON
		INNER JOIN DEBT_PERSONAL_REPAY_LIST DPRL ON
			(
				DPI.NO_PERSON = DPRL.NO_PERSON
				AND DPI.NO_MANAGE_INFO = DPRL.NO_MANAGE_INFO
				AND DPRL.REQ_YYYYMM = TO_CHAR( SYSDATE, 'YYYYMM' )
			)
		WHERE
			DPI.YMD_CANCEL IS NULL
			AND DPI.DISPLAY_YN = 'Y'
			AND DPRL.PAYMENT_YMD = TO_CHAR( SYSDATE+1, 'YYYYMMDD' )

    </select>
</mapper>

